#+TITLE: org-agenda
#+PROPERTY: header-args:emacs-lisp :tangle yes :comments both

#+begin_src emacs-lisp :comments no :padline no
;;; toncs-config-org-agenda.el -*- lexical-binding: t -*-
#+end_src

#+begin_src emacs-lisp
(require 'org-agenda)
(require 'org-habit)
(require 'counsel)
(require 'avy)

(defconst toncs-agenda-categories
  (list "task" "routine" "event" "leave" "anniv" "log" "holiday" "sprint" "habit")
  "ã‚¢ã‚¸ã‚§ãƒ³ãƒ€ã§ä½¿ã†ã‚«ãƒ†ã‚´ãƒªã®ãƒªã‚¹ãƒˆã§ã™ã€‚ã“ã“ã«ã‚ã‚‹ã‚«ãƒ†ã‚´ãƒªã«ã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ã€‚")

(defun toncs-avy-org-agenda-cands ()
  (let (candidates point)
    (save-excursion
      (save-restriction
        (narrow-to-region (window-start) (window-end (selected-window) t))
        (setq point (goto-char (point-min)))
        (while (setq point (text-property-not-all point (window-end) 'org-marker nil))
          (push (cons point (selected-window)) candidates)
          (setq point (text-property-any point (window-end) 'org-marker nil)))))
    (nreverse candidates)))

(defun toncs-avy-org-agenda ()
  "Goto a visible item in an `org-mode-agenda' buffer."
  (interactive)
  (avy-action-goto (avy-with avy-org-agenda
			     (avy-process (toncs-avy-org-agenda-cands)))))

(defun toncs-setup-custom-agenda-commands ()
  (dolist (command '(("u" "ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‚¿ã‚¹ã‚¯" todo ""
                      ((org-agenda-todo-ignore-scheduled 'all)))
                     ("r" "æœ€è¿‘ä½œæˆã•ã‚ŒãŸã‚¨ãƒ³ãƒˆãƒª" tags "CREATED>=\"<-2w>\"|TIMESTAMP_IA>=\"<-2w>\""
                      ((org-agenda-max-entries 50)))
                     ("w" "Weekly" agenda ""
                      ((org-agenda-span 'week)
                       (org-agenda-use-time-grid nil)
                       (org-agenda-show-all-dates nil)
                       (org-agenda-start-with-log-mode nil)))
                     ("N" "ãƒ«ãƒ¼ãƒãƒ³ãƒ¯ãƒ¼ã‚¯ä»¥å¤–" todo ""
                      ((org-agenda-category-filter-preset '("-routine" "-habit"))))
                     ("A" "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å€™è£œ" tags "CLOSED<\"<-3m>\"|CREATED<\"<-3m>\"|TIMESTAMP_IA<\"<-3m>\"|TIMESTAMP<\"<-3m>\"|SCHEDULED<\"<-3m>\"|DEADLINE<\"<-3m>\"/-TODO"
                      ((org-agenda-max-entries 500)))
                     ("R" "ãƒªãƒ•ã‚¡ã‚¤ãƒ«å€™è£œ" tags "refileme"
                      ((org-tags-match-list-sublevels nil)))
                     ("D" "ç· åˆ‡ã®ã¿" agenda ""
                      ((org-agenda-span 'month)
                       (org-agenda-time-grid nil)
                       (org-agenda-show-all-dates nil)
                       (org-agenda-start-with-log-mode nil)
                       (org-agenda-entry-types '(:deadline))
                       (org-deadline-warning-days 0)))
                     ("E" "äºˆå®šã®ã¿" agenda ""
                      ((org-agenda-span 'week)
                       (org-agenda-time-grid nil)
                       (org-agenda-show-all-dates nil)
                       (org-agenda-start-with-log-mode nil)
                       (org-agenda-entry-types '(:timestamp :sexp))))))
    (add-to-list 'org-agenda-custom-commands command)))

(defun toncs-config-org-agenda-configure ()
  (setq org-agenda-restore-windows-after-quit t)
  (setq org-agenda-deadline-leaders '("â°" "ğŸ”œ%2dæ—¥å¾Œ" "âš %2dæ—¥è¶…é"))
  (setq org-agenda-scheduled-leaders '("ğŸ“…" "ğŸ“Œ%2dæ—¥å‰"))
  (setq org-agenda-format-date "%-mæœˆ%eæ—¥(%a) %_20Yå¹´")
  (setq org-agenda-show-current-time-in-grid t)
  (setq org-agenda-time-grid
        `((daily today require-timed)
          ,(number-sequence 800 1700 100)
          " ....... "
          "â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•"))
  (setq org-agenda-current-time-string "â®â€•â€•â€• now")
  (setq org-agenda-compact-blocks t)
  (setq org-agenda-skip-unavailable-files t)
  (setq org-agenda-category-icon-alist 
        (mapcar (lambda (category)
                  `(,category ,(locate-user-emacs-file (concat "res/" category ".svg")) nil nil :ascent center))
                toncs-agenda-categories))
  (setq org-agenda-breadcrumbs-separator " â± ")
  (setq org-agenda-prefix-format '((agenda . " %i %?-12t% s")
                                   (todo . " %i% s%?b")
                                   (tags . " %i")
                                   (search . " %i")))
  (setq org-agenda-clockreport-parameter-plist
	'(:hidefiles t :properties ("CATEGORY") :lang "ja" :link t :compact t :stepskip0 t :fileskip0 t)
        org-agenda-log-mode-items '(clock))
  (setq org-agenda-sorting-strategy '((agenda time-up habit-down priority-down category-keep)
                                      (todo   priority-down category-keep)
                                      (tags   priority-down category-keep)
                                      (search category-keep)))
  (setq org-agenda-menu-show-matcher nil)
  (setq org-agenda-menu-two-columns t)
  (toncs-setup-custom-agenda-commands)

  (general-def org-agenda-mode-map
    "C-c C-q" #'counsel-org-tag-agenda
    "J" #'toncs-avy-org-agenda)

  (set-face-underline 'org-agenda-current-time nil))
#+end_src

#+begin_src emacs-lisp :comments no
(provide 'toncs-config-org-agenda)
;;; toncs-config-org-agenda.el ends here
#+end_src
